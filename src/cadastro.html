<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>GoalWallet - Criar Conta</title>
        <link rel="stylesheet" href="css/style.css" />
    </head>

    <body>
        <main class="container-center">
            <section class="card" role="region" aria-labelledby="titulo">

                <div class="logo">
                    <img src="img/logo.png" alt="Logo Goal Wallet" />
                    <h1 id="titulo">Goal Wallet</h1> 
                </div>

                <h2 style="margin:0 0 18px 0; font-size: 20px;">Crie sua conta </h2>

                <form action="#" method="post" novalidate>
                    <div class="field">
                        <label class="label" for="nome">Nome Completo</label>
                        <input class="input" id="nome" name="nome" type="text" placeholder="Digite seu Nome Completo" required />
                    </div>

                     <div class="field">
          <label class="label" for="email">E-mail</label>
          <input class="input" id="email" name="email" type="email" placeholder="seuemail@exemplo.com" required />
        </div>

        <div class="field">
          <label class="label" for="cpf">CPF</label>
          <input class="input" id="cpf" name="cpf" type="text" placeholder="000.000.000-00" required />
        </div>

        <div class="field">
          <label class="label" for="senha">Senha</label>
          <input class="input" id="senha" name="senha" type="password" placeholder="Crie uma senha" required />
          <div id="senha-strength" style="margin-top: 8px; display: none;">
            <div style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
              <div id="senha-strength-bar" style="height: 100%; width: 0%; transition: all 0.3s ease;"></div>
            </div>
            <div id="senha-strength-label" style="font-size: 12px; margin-top: 4px;"></div>
          </div>
        </div>

        <button class="button" type="submit">Criar Conta</button>
      </form>

      <p class="text-center" style="margin-top:14px; font-size:14px;">
        Já possui uma conta? <a class="link" href="index.html">Entrar</a>
      </p>
    </section>
  </main>

  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/route-guard.js"></script>
  <script>
    console.log('=== CADASTRO.HTML DEBUG ===');
    console.log('1. Script carregado');
    console.log('2. Utils disponível?', typeof Utils !== 'undefined');
    console.log('3. Auth disponível?', typeof Auth !== 'undefined');
    console.log('4. RouteGuard disponível?', typeof RouteGuard !== 'undefined');
    
    try {
      console.log('5. Chamando RouteGuard.redirectIfAuthenticated()...');
      RouteGuard.redirectIfAuthenticated();
      console.log('6. RouteGuard executado com sucesso');
    } catch(e) {
      console.error('ERRO no RouteGuard:', e);
    }

    const form = document.querySelector('form');
    const nomeInput = document.getElementById('nome');
    const emailInput = document.getElementById('email');
    const cpfInput = document.getElementById('cpf');
    const senhaInput = document.getElementById('senha');
    const senhaStrengthDiv = document.getElementById('senha-strength');
    const senhaStrengthBar = document.getElementById('senha-strength-bar');
    const senhaStrengthLabel = document.getElementById('senha-strength-label');

    console.log('7. Form encontrado?', form !== null);
    console.log('8. Inputs encontrados?', {
      nome: nomeInput !== null,
      email: emailInput !== null,
      cpf: cpfInput !== null,
      senha: senhaInput !== null
    });

    cpfInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      
      if (value.length <= 11) {
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      }
      
      e.target.value = value;
    });

    cpfInput.addEventListener('blur', function() {
      const cpf = this.value;
      if (cpf) {
        const isValid = Utils.validateCPF(cpf);
        Utils.showFieldFeedback(this, isValid, isValid ? '' : 'CPF inválido');
      }
    });

    emailInput.addEventListener('blur', function() {
      const email = this.value.trim();
      if (email) {
        const isValid = Utils.validateEmail(email);
        Utils.showFieldFeedback(this, isValid, isValid ? '' : 'Email inválido');
      }
    });

    nomeInput.addEventListener('blur', function() {
      const nome = this.value.trim();
      if (nome) {
        const isValid = nome.length >= 3;
        Utils.showFieldFeedback(this, isValid, isValid ? '' : 'Nome deve ter pelo menos 3 caracteres');
      }
    });

    senhaInput.addEventListener('input', function() {
      const senha = this.value;
      
      if (senha.length > 0) {
        senhaStrengthDiv.style.display = 'block';
        const strength = Utils.getSenhaStrength(senha);
        
        senhaStrengthBar.style.width = ((strength.strength + 1) * 20) + '%';
        senhaStrengthBar.style.background = strength.color;
        senhaStrengthLabel.textContent = strength.label;
        senhaStrengthLabel.style.color = strength.color;
      } else {
        senhaStrengthDiv.style.display = 'none';
      }
    });

    senhaInput.addEventListener('blur', function() {
      const senha = this.value;
      if (senha) {
        const isValid = Utils.validateSenha(senha);
        Utils.showFieldFeedback(this, isValid, isValid ? '' : 'Senha deve ter pelo menos 6 caracteres');
      }
    });

    form.addEventListener('submit', function(e) {
      console.log('9. === SUBMIT CLICADO ===');
      e.preventDefault();
      console.log('10. PreventDefault executado');

      const nome = nomeInput.value.trim();
      const email = emailInput.value.trim();
      const cpf = cpfInput.value;
      const senha = senhaInput.value;

      console.log('11. Valores capturados:', { nome, email, cpf, senha: '***' });

      if (!nome || !email || !cpf || !senha) {
        Utils.showToast('Preencha todos os campos', 'error');
        return;
      }

      if (nome.length < 3) {
        Utils.showToast('Nome deve ter pelo menos 3 caracteres', 'error');
        nomeInput.focus();
        return;
      }

      if (!Utils.validateEmail(email)) {
        Utils.showToast('Email inválido', 'error');
        emailInput.focus();
        return;
      }

      if (!Utils.validateCPF(cpf)) {
        Utils.showToast('CPF inválido', 'error');
        cpfInput.focus();
        return;
      }

      if (!Utils.validateSenha(senha)) {
        Utils.showToast('Senha deve ter pelo menos 6 caracteres', 'error');
        senhaInput.focus();
        return;
      }

      console.log('12. Chamando Auth.registrar()...');
      
      Utils.showLoading('Criando sua conta...');
      
      setTimeout(() => {
        const result = Auth.registrar({
          nome,
          email,
          cpf,
          senha
        });
        console.log('13. Resultado:', result);

        Utils.hideLoading();

        if (result.success) {
          console.log('14. Sucesso! Redirecionando...');
          Utils.showToast(result.message, 'success');
          
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1000);
        } else {
          console.log('15. Erro:', result.message);
          Utils.showToast(result.message, 'error');
        }
      }, 500);
    });
    
    console.log('16. Event listener adicionado ao form');
  </script>
</body>
</html>