<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hist√≥rico ‚Äî GoalWallet</title>
  <link rel="stylesheet" href="css/historico.css">
  <style>
    /* Modal de Categorias - Estilos espec√≠ficos */
    
    button,
    .btn,
    .pill,
    .icon-btn {
      background: #58a6ff !important;
      color: #08224f !important;
      border-color: #58a6ff !important;
      font-weight: 600;
    }

    button.outline,
    .btn.outline {
      background: transparent !important;
      color: #58a6ff !important;
      border: 1px solid #58a6ff !important;
    }

    button:hover,
    .btn:hover,
    .pill:hover,
    .icon-btn:hover {
      filter: brightness(1.15);
    }

    /* Modal de Categorias - Estilos espec√≠ficos */
    #modal-categories {
      z-index: 9999;
      padding: 20px;
    }
    
    #modal-categories .sheet {
      background: linear-gradient(180deg, #123a82, #0f3a7a) !important;
      border: 1px solid #2a59b3 !important;
      color: #fff !important;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5) !important;
      max-width: 600px !important;
      width: 100% !important;
    }
    
    #modal-categories h3,
    #modal-categories h4 {
      color: #ffffff !important;
    }
    
    #modal-categories .field label {
      color: #eaf1ff !important;
      font-weight: 500;
    }
    
    #modal-categories .input {
      background: rgba(255,255,255,0.08) !important;
      border: 1px solid rgba(255,255,255,0.15) !important;
      color: #fff !important;
      font-size: 14px;
    }
    
    #modal-categories .input::placeholder {
      color: rgba(255,255,255,0.5);
    }
    
    #modal-categories .input:focus {
      background: rgba(255,255,255,0.12) !important;
      border-color: #58a6ff !important;
      outline: none;
    }
    
    /* Bot√µes de tab */
    #tab-receitas,
    #tab-despesas {
      color: #fff !important;
      font-weight: 600 !important;
      padding: 12px;
    }
    
    #tab-receitas.btn:not(.outline) {
      background: #58a6ff !important;
      color: #08224f !important;
    }
    
    #tab-despesas.btn:not(.outline) {
      background: #58a6ff !important;
      color: #08224f !important;
    }
    
    /* Bot√£o Adicionar */
    #form-new-category button[type="submit"] {
      background: #58a6ff !important;
      color: #08224f !important;
      font-weight: 600 !important;
    }
    
    /* Bot√£o Fechar */
    #close-categories {
      color: #fff !important;
      border-color: rgba(255,255,255,0.3) !important;
    }
    
    #close-categories:hover {
      background: rgba(255,255,255,0.1) !important;
      border-color: rgba(255,255,255,0.5) !important;
    }
    
    #modal-categories {
      z-index: 9999;
      padding: 20px;
    }
    
    #modal-categories .sheet {
      background: linear-gradient(180deg, #123a82, #0f3a7a) !important;
      border: 1px solid #2a59b3 !important;
      color: #fff !important;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5) !important;
      max-width: 600px !important;
      width: 100% !important;
    }
    
    #modal-categories h3,
    #modal-categories h4 {
      color: #ffffff !important;
    }
    
    #modal-categories .field label {
      color: #eaf1ff !important;
      font-weight: 500;
    }
    
    #modal-categories .input {
      background: rgba(255,255,255,0.08) !important;
      border: 1px solid rgba(255,255,255,0.15) !important;
      color: #fff !important;
      font-size: 14px;
    }
    
    #modal-categories .input::placeholder {
      color: rgba(255,255,255,0.5);
    }
    
    #modal-categories .input:focus {
      background: rgba(255,255,255,0.12) !important;
      border-color: #58a6ff !important;
      outline: none;
    }
    
    /* Bot√µes de tab */
    #tab-receitas,
    #tab-despesas {
      color: #fff !important;
      font-weight: 600 !important;
    }
    
    #tab-receitas.btn:not(.outline) {
      background: #58a6ff !important;
      color: #08224f !important;
    }
    
    #tab-despesas.btn:not(.outline) {
      background: #58a6ff !important;
      color: #08224f !important;
    }
    
    /* Bot√£o Adicionar */
    #form-new-category button[type="submit"] {
      background: #58a6ff !important;
      color: #08224f !important;
      font-weight: 600 !important;
    }
    
    /* Bot√£o Fechar */
    #close-categories {
      color: #fff !important;
      border-color: rgba(255,255,255,0.3) !important;
    }
    
    #close-categories:hover {
      background: rgba(255,255,255,0.1) !important;
      border-color: rgba(255,255,255,0.5) !important;
    }
    /* === BOT√ÉO DE DESPESAS VERMELHO === */
#tab-despesas.btn,
#tab-despesas {
  background: #ff4d4d !important;   /* vermelho */
  color: #ffffff !important;
  border-color: #ff4d4d !important;
  padding: 18px;
}

#tab-despesas:hover {
  filter: brightness(1.15);
}
/* === BOT√ÉO ADICIONAR DESPESA === */
.btn-add-despesa,
#btn-add-despesa {
  background: #ff4d4d !important;   /* vermelho */
  color: #fff !important;
  border-color: #ff4d4d !important;
  font-weight: 600;
  padding: 12px;
}

.btn-add-despesa:hover,
#btn-add-despesa:hover {
  filter: brightness(1.15);
}
/* === BOT√ÉO ADICIONAR RECEITA ‚Äî VERDE === */
#btn-add-receita,
.btn-add-receita {
  background: #3ecf8e !important;     /* verde bonito */
  color: #07381b !important;
  border-color: #3ecf8e !important;
  font-weight: 600 !important;
  border-radius: 18px;
}

#btn-add-receita:hover,
.btn-add-receita:hover {
  filter: brightness(1.15);  
}

  </style>
</head>
<body>
  <main class="app" role="main" aria-labelledby="main-title">
    <header class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true">
         <a href="dashboard.html"><img src="img/logo.png" alt="" style="width:44px;height:44px;object-fit:contain"></a>
        </div>
        <div>
          <h1 id="main-title">GoalWallet</h1>
          <div class="subtitle">Hist√≥rico de Transa√ß√µes</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <button id="toggle-edit" class="pill" aria-pressed="false" type="button" title="Editar transa√ß√µes">Editar</button>
        <button id="profile-top" class="icon-btn" aria-label="Acesso ao perfil" title="Perfil">
          <a href="usuario.html"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6" aria-hidden="true">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"></path>
            <path d="M4 20c0-3.31 2.69-6 6-6h4c3.31 0 6 2.69 6 6"></path>
          </svg></a>
        </button>
      </div>
    </header>

    <!-- Filtros -->
    <section style="margin-bottom: 20px;">
      <button id="toggle-filters" class="btn outline small" style="width: 100%;">
        üîç Filtros Avan√ßados
      </button>
      <div id="filters-panel" style="display: none; margin-top: 12px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
          <div class="field">
            <label style="font-size: 12px; color: rgba(255,255,255,0.8);">Data In√≠cio</label>
            <input type="date" id="filter-date-start" class="input" style="font-size: 13px;" />
          </div>
          <div class="field">
            <label style="font-size: 12px; color: rgba(255,255,255,0.8);">Data Fim</label>
            <input type="date" id="filter-date-end" class="input" style="font-size: 13px;" />
          </div>
          <div class="field">
            <label style="font-size: 12px; color: rgba(255,255,255,0.8);">Categoria</label>
            <select id="filter-category" class="input" style="font-size: 13px;">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="field">
            <label style="font-size: 12px; color: rgba(255,255,255,0.8);">Conta</label>
            <select id="filter-account" class="input" style="font-size: 13px;">
              <option value="">Todas</option>
            </select>
          </div>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 12px; justify-content: flex-end;">
          <button id="btn-clear-filters" class="btn small outline">Limpar</button>
          <button id="btn-apply-filters" class="btn small">Aplicar</button>
          <button id="btn-export" class="btn small" style="background: #8fffa5; color: #000;">üì• Exportar</button>
        </div>
      </div>
    </section>

    <div class="grid-2" role="group" aria-label="Listas de transa√ß√µes">
      <section aria-labelledby="pendentes">
        <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h2 id="pendentes" class="section-title">Pendentes</h2>
        </div>

        <div class="list-wrapper">
          <div id="pendentes-list" class="scheduled" role="list" aria-label="Lista de pendentes"></div>
        </div>
      </section>

      <section aria-labelledby="historico">
        <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h2 id="historico" class="section-title">Hist√≥rico</h2>
        </div>

        <div class="list-wrapper">
          <div id="historico-list" class="scheduled" role="list" aria-label="Hist√≥rico de transa√ß√µes"></div>
        </div>
      </section>
    </div>

    <section style="margin-top:25px;" aria-labelledby="quick-actions">
      <h2 id="quick-actions" class="section-title">A√ß√µes r√°pidas</h2>
      <div class="actions">
  <button class="btn-add-receita" id="add-income" aria-haspopup="dialog" type="button">
    Adicionar Receita
  </button>

  <button class="btn-add-despesa" id="add-expense" aria-haspopup="dialog" type="button">
    Adicionar Despesa
  </button>
</div>


      <!-- NOVO BLOCO DE SALDO -->
      <div id="totals-wrapper">
        <div class="total-line" id="saldo-consolidado">Saldo consolidado: R$ 0,00</div>
        <div class="total-line" id="saldo-previsto">Saldo previsto: R$ 0,00</div>
      </div>
    </section>

    <!-- MODAL -->
    <div class="modal" id="modal" aria-hidden="true">
      <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1">
        <h3 id="modal-title">Nova transa√ß√£o</h3>
        <form id="tx-form" novalidate>

          <div class="field">
            <label for="t-title">T√≠tulo</label>
            <input id="t-title" name="title" type="text" autocomplete="off" />
          </div>

          <div class="field">
            <label for="t-value">Valor</label>
            <input id="t-value" name="value" type="text" inputmode="decimal" placeholder="0,00" autocomplete="off" />
          </div>

          <div class="field">
            <label for="t-date">Data</label>
            <input id="t-date" name="date" type="date" />
          </div>

          <div class="field">
            <label for="t-account">Conta</label>
            <select id="t-account" name="account">
              <option value="">Selecione uma conta</option>
            </select>
          </div>

          <div class="field">
            <label for="t-category">Categoria</label>
            <select id="t-category" name="category">
              <option value="">Selecione uma categoria</option>
            </select>
          </div>

          <!-- CAMPO TIPO ‚Äî SOMENTE NO EDITAR -->
          <div class="field" id="field-type">
            <label>Tipo</label>
            <div style="display:flex;gap:8px">
              <label><input type="radio" name="type" value="expense" /> Despesa</label>
              <label><input type="radio" name="type" value="income" /> Receita</label>
            </div>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="btn" id="cancel" type="button">Cancelar</button>
            <button class="btn green" id="save" type="submit">Salvar</button>
          </div>

        </form>
        
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
          <button id="btn-manage-categories" class="btn" type="button" style="width: 100%; font-size: 13px;">
            ‚öôÔ∏è Gerenciar Categorias
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Categorias -->
    <div class="modal" id="modal-categories" aria-hidden="true" style="display: none;">
      <div class="sheet" role="dialog" aria-modal="true" style="max-width: 550px; padding: 24px; background: linear-gradient(180deg, var(--card), var(--card-2)); border: 1px solid var(--border);">
        <h3 style="margin-top: 0; font-size: 20px; color: #fff; font-weight: 600;">‚öôÔ∏è Gerenciar Categorias</h3>
        
        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
          <button id="tab-receitas" class="btn small" style="flex: 1; font-size: 14px; padding: 10px;">üí∞ Receitas</button>
          <button id="tab-despesas" class="btn small outline" style="flex: 1; font-size: 14px; padding: 10px;">üí∏ Despesas</button>
        </div>

        <div id="categories-list" style="max-height: 320px; overflow-y: auto; margin-bottom: 20px; padding: 8px; background: rgba(0,0,0,0.15); border-radius: 8px;">
          <!-- Categorias ser√£o inseridas aqui -->
        </div>

        <div style="border-top: 2px solid rgba(255,255,255,0.15); padding-top: 16px; margin-top: 16px;">
          <h4 style="font-size: 15px; margin: 0 0 12px 0; color: rgba(255,255,255,0.9); font-weight: 600;">‚ûï Nova Categoria</h4>
          <form id="form-new-category" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: end;">
            <div class="field" style="flex: 1; min-width: 150px; margin: 0;">
              <label style="display: block; font-size: 12px; margin-bottom: 4px; color: rgba(255,255,255,0.8);">Nome</label>
              <input id="new-cat-name" type="text" placeholder="Ex: Alimenta√ß√£o" class="input" style="width: 100%; font-size: 14px;" />
            </div>
            <div class="field" style="margin: 0;">
              <label style="display: block; font-size: 12px; margin-bottom: 4px; color: rgba(255,255,255,0.8);">√çcone</label>
              <input id="new-cat-icon" type="text" placeholder="üéØ" maxlength="2" class="input" style="width: 70px; text-align: center; font-size: 16px;" />
            </div>
            <div class="field" style="margin: 0;">
              <label style="display: block; font-size: 12px; margin-bottom: 4px; color: rgba(255,255,255,0.8);">Cor</label>
              <input id="new-cat-color" type="color" value="#58a6ff" class="input" style="width: 70px; padding: 6px; height: 42px;" />
            </div>
            <button type="submit" class="btn small" style="font-size: 14px; padding: 10px 16px;">Adicionar</button>
          </form>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
          <button id="close-categories" class="btn outline" style="font-size: 14px; padding: 10px 20px;">Fechar</button>
        </div>
      </div>
    </div>
  </main>

  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Sistema -->
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/route-guard.js"></script>
  <script src="js/accounts.js"></script>
  <script src="js/categories.js"></script>
  <script src="js/transactions.js"></script>
  <script>
    // Protege a p√°gina
    RouteGuard.protect();
    // Protege a p√°gina
    RouteGuard.protect();

    // === ELEMENTOS DOM ===
    const pendentesList = document.getElementById('pendentes-list');
    const historicoList = document.getElementById('historico-list');
    const toggleEdit = document.getElementById('toggle-edit');
    const addIncomeBtn = document.getElementById('add-income');
    const addExpenseBtn = document.getElementById('add-expense');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const txForm = document.getElementById('tx-form');
    const cancelBtn = document.getElementById('cancel');
    const fieldType = document.getElementById('field-type');
    const accountSelect = document.getElementById('t-account');
    const categorySelect = document.getElementById('t-category');

    // Modal de categorias
    const modalCategories = document.getElementById('modal-categories');
    const btnManageCategories = document.getElementById('btn-manage-categories');
    const closeCategoriesBtn = document.getElementById('close-categories');
    const tabReceitas = document.getElementById('tab-receitas');
    const tabDespesas = document.getElementById('tab-despesas');
    const categoriesList = document.getElementById('categories-list');
    const formNewCategory = document.getElementById('form-new-category');

    let isEditMode = false;
    let editingId = null;
    let currentType = 'despesa';
    let categoryTabType = 'receita';
    let activeFilters = {};

    // === INICIALIZAR ===
    Categories.init();

    // === ELEMENTOS DE FILTRO ===
    const toggleFiltersBtn = document.getElementById('toggle-filters');
    const filtersPanel = document.getElementById('filters-panel');
    const filterDateStart = document.getElementById('filter-date-start');
    const filterDateEnd = document.getElementById('filter-date-end');
    const filterCategory = document.getElementById('filter-category');
    const filterAccount = document.getElementById('filter-account');
    const btnApplyFilters = document.getElementById('btn-apply-filters');
    const btnClearFilters = document.getElementById('btn-clear-filters');
    const btnExport = document.getElementById('btn-export');

    // === TOGGLE FILTROS ===
    toggleFiltersBtn.addEventListener('click', () => {
      const isVisible = filtersPanel.style.display !== 'none';
      filtersPanel.style.display = isVisible ? 'none' : 'block';
      toggleFiltersBtn.textContent = isVisible ? 'üîç Filtros Avan√ßados' : '‚úï Fechar Filtros';
    });

    // === CARREGAR CONTAS NO SELECT ===
    function loadAccountsSelect() {
      const accounts = Accounts.getByUser();
      accountSelect.innerHTML = '';

      if (accounts.length === 0) {
        accountSelect.innerHTML = '<option value="">Nenhuma conta cadastrada</option>';
        return;
      }

      accounts.forEach(acc => {
        const option = document.createElement('option');
        option.value = acc.id;
        option.textContent = `${acc.nome} - ${acc.tipo}`;
        accountSelect.appendChild(option);
      });
    }

    // === CARREGAR CATEGORIAS NO SELECT ===
    function loadCategoriesSelect(tipo) {
      const categories = Categories.getByType(tipo);
      categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';

      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.nome;
        option.textContent = `${cat.icone} ${cat.nome}`;
        option.dataset.color = cat.cor;
        categorySelect.appendChild(option);
      });
    }

    // === CARREGAR FILTROS ===
    function loadFilterSelects() {
      // Carregar contas
      const accounts = Accounts.getByUser();
      filterAccount.innerHTML = '<option value="">Todas</option>';
      accounts.forEach(acc => {
        const option = document.createElement('option');
        option.value = acc.id;
        option.textContent = `${acc.nome} - ${acc.tipo}`;
        filterAccount.appendChild(option);
      });

      // Carregar categorias (todas)
      const receitaCats = Categories.getByType('receita');
      const despesaCats = Categories.getByType('despesa');
      filterCategory.innerHTML = '<option value="">Todas</option>';
      
      const optgroupReceitas = document.createElement('optgroup');
      optgroupReceitas.label = 'Receitas';
      receitaCats.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.nome;
        option.textContent = `${cat.icone} ${cat.nome}`;
        optgroupReceitas.appendChild(option);
      });
      
      const optgroupDespesas = document.createElement('optgroup');
      optgroupDespesas.label = 'Despesas';
      despesaCats.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.nome;
        option.textContent = `${cat.icone} ${cat.nome}`;
        optgroupDespesas.appendChild(option);
      });
      
      filterCategory.appendChild(optgroupReceitas);
      filterCategory.appendChild(optgroupDespesas);
    }

    // === APLICAR FILTROS ===
    btnApplyFilters.addEventListener('click', () => {
      activeFilters = {};

      if (filterDateStart.value) {
        activeFilters.dataInicio = filterDateStart.value;
      }

      if (filterDateEnd.value) {
        activeFilters.dataFim = filterDateEnd.value;
      }

      if (filterCategory.value) {
        activeFilters.categoria = filterCategory.value;
      }

      if (filterAccount.value) {
        activeFilters.contaId = filterAccount.value;
      }

      renderLists();
      Utils.showToast('Filtros aplicados', 'info', 2000);
    });

    // === LIMPAR FILTROS ===
    btnClearFilters.addEventListener('click', () => {
      activeFilters = {};
      filterDateStart.value = '';
      filterDateEnd.value = '';
      filterCategory.value = '';
      filterAccount.value = '';
      renderLists();
      Utils.showToast('Filtros removidos', 'info', 2000);
    });

    // === EXPORTAR DADOS ===
    btnExport.addEventListener('click', async () => {
      const formato = await Utils.showConfirm(
        'Escolha o formato de exporta√ß√£o:',
        'CSV',
        'JSON'
      );

      const transactions = Transactions.getFiltered(activeFilters);

      if (transactions.length === 0) {
        Utils.showToast('Nenhuma transa√ß√£o para exportar', 'warning');
        return;
      }

      let content, filename, type;

      if (formato) {
        // CSV
        const headers = ['Data', 'Descri√ß√£o', 'Categoria', 'Tipo', 'Valor', 'Conta'];
        const rows = transactions.map(t => {
          const conta = Accounts.getById(t.contaId);
          return [
            t.data,
            t.descricao,
            t.categoria,
            t.tipo,
            t.valor.toFixed(2),
            conta ? conta.nome : 'N/A'
          ];
        });

        content = [headers, ...rows].map(row => row.join(',')).join('\n');
        filename = `transacoes_${new Date().toISOString().split('T')[0]}.csv`;
        type = 'text/csv;charset=utf-8;';
      } else {
        // JSON
        const data = transactions.map(t => {
          const conta = Accounts.getById(t.contaId);
          return {
            ...t,
            nomeConta: conta ? conta.nome : 'N/A'
          };
        });

        content = JSON.stringify(data, null, 2);
        filename = `transacoes_${new Date().toISOString().split('T')[0]}.json`;
        type = 'application/json;charset=utf-8;';
      }

      // Download
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      Utils.showToast(`${transactions.length} transa√ß√µes exportadas!`, 'success');
    });

    // === CRIAR CARD DE TRANSA√á√ÉO ===
    function createTransactionCard(tx) {
      const card = document.createElement('div');
      card.className = 'card';
      card.setAttribute('role', 'listitem');
      card.dataset.id = tx.id;

      const conta = Accounts.getById(tx.contaId);
      const nomeConta = conta ? conta.nome : 'Conta removida';

      const valorClass = tx.tipo === 'receita' ? 'income' : 'expense';
      const valorFormatado = Transactions.formatarValor(tx.valor);
      const dataFormatada = Transactions.formatarData(tx.data);

      card.innerHTML = `
        <div class="tx-left">
          <div class="small tx-title">${Utils.sanitizeString(tx.descricao)}</div>
          <div class="subtle tx-sub">${Utils.sanitizeString(tx.categoria)} ‚Ä¢ ${nomeConta}</div>
        </div>
        <div class="tx-right">
          <div class="amount tx-amt ${valorClass}">${valorFormatado}</div>
          <div class="subtle" style="font-size:12px">${dataFormatada}</div>
          <div class="tx-actions" style="display:${isEditMode ? 'flex' : 'none'};gap:4px;margin-top:4px">
            <button type="button" class="icon-btn" data-action="edit" title="Editar">‚úé</button>
            <button type="button" class="icon-btn" data-action="delete" title="Excluir">üóë</button>
          </div>
        </div>
      `;

      return card;
    }

    // === RENDERIZAR LISTAS ===
    function renderLists() {
      const transactions = Transactions.getFiltered(activeFilters);
      
      // Separa transa√ß√µes futuras e passadas
      const hoje = new Date().toISOString().split('T')[0];
      const pendentes = transactions.filter(t => t.data > hoje);
      const historico = transactions.filter(t => t.data <= hoje);

      // Renderiza pendentes
      pendentesList.innerHTML = '';
      if (pendentes.length === 0) {
        pendentesList.innerHTML = '<div class="muted">Nenhuma transa√ß√£o futura.</div>';
      } else {
        pendentes.forEach(tx => {
          pendentesList.appendChild(createTransactionCard(tx));
        });
      }

      // Renderiza hist√≥rico
      historicoList.innerHTML = '';
      if (historico.length === 0) {
        historicoList.innerHTML = '<div class="muted">Nenhuma transa√ß√£o realizada.</div>';
      } else {
        historico.forEach(tx => {
          historicoList.appendChild(createTransactionCard(tx));
        });
      }

      updateTotals();
      updateFiltersInfo();
    }

    // === ATUALIZAR INFO DE FILTROS ===
    function updateFiltersInfo() {
      const hasFilters = Object.keys(activeFilters).some(key => activeFilters[key]);
      if (hasFilters) {
        toggleFiltersBtn.textContent = 'üîç Filtros Ativos';
        toggleFiltersBtn.style.background = '#58a6ff';
        toggleFiltersBtn.style.color = 'white';
      } else {
        toggleFiltersBtn.textContent = 'üîç Filtros Avan√ßados';
        toggleFiltersBtn.style.background = '';
        toggleFiltersBtn.style.color = '';
      }
    }

    // === ATUALIZAR TOTAIS ===
    function updateTotals() {
      const stats = Transactions.getEstatisticas();
      const saldoConsolidado = Accounts.getSaldoConsolidado();

      document.getElementById('saldo-consolidado').textContent = 
        'Saldo consolidado: ' + Accounts.formatarSaldo(saldoConsolidado);

      const saldoPrevisto = saldoConsolidado;
      document.getElementById('saldo-previsto').textContent = 
        'Saldo previsto: ' + Accounts.formatarSaldo(saldoPrevisto);
    }

    // === TOGGLE EDIT MODE ===
    toggleEdit.addEventListener('click', () => {
      isEditMode = !isEditMode;
      toggleEdit.setAttribute('aria-pressed', String(isEditMode));
      toggleEdit.textContent = isEditMode ? 'Concluir edi√ß√£o' : 'Editar';
      renderLists();
    });

    // === ABRIR MODAL CRIAR ===
    function openModal(tipo) {
      currentType = tipo;
      editingId = null;

      modalTitle.textContent = tipo === 'receita' ? 'Nova Receita' : 'Nova Despesa';
      fieldType.style.display = 'none';

      txForm.reset();
      txForm.elements['date'].valueAsDate = new Date();
      loadAccountsSelect();
      loadCategoriesSelect(tipo);

      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    // === ABRIR MODAL EDITAR ===
    function openEditModal(id) {
      const tx = Transactions.getById(id);
      if (!tx) return;

      editingId = id;
      currentType = tx.tipo;

      modalTitle.textContent = 'Editar Transa√ß√£o';
      fieldType.style.display = 'block';

      loadAccountsSelect();
      loadCategoriesSelect(tx.tipo);

      txForm.elements['title'].value = tx.descricao;
      txForm.elements['value'].value = tx.valor.toFixed(2).replace('.', ',');
      txForm.elements['date'].value = tx.data;
      txForm.elements['account'].value = tx.contaId;
      txForm.elements['category'].value = tx.categoria;

      // Marca tipo
      Array.from(txForm.elements['type']).forEach(radio => {
        radio.checked = radio.value === (tx.tipo === 'receita' ? 'income' : 'expense');
      });

      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    // === FECHAR MODAL ===
    function closeModal() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }

    // === BOT√ïES ABRIR MODAL ===
    addIncomeBtn.addEventListener('click', () => openModal('receita'));
    addExpenseBtn.addEventListener('click', () => openModal('despesa'));
    cancelBtn.addEventListener('click', closeModal);

    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // === SUBMIT FORM ===
    txForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const descricao = txForm.elements['title'].value.trim();
      const valorStr = txForm.elements['value'].value.replace(/[^\d,]/g, '').replace(',', '.');
      const valor = parseFloat(valorStr);
      const data = txForm.elements['date'].value;
      const contaId = txForm.elements['account'].value;
      const categoria = txForm.elements['category'].value;

      // Valida√ß√µes
      if (!descricao) {
        Utils.showToast('Preencha a descri√ß√£o', 'error');
        return;
      }

      if (isNaN(valor) || valor <= 0) {
        Utils.showToast('Valor inv√°lido', 'error');
        return;
      }

      if (!data) {
        Utils.showToast('Selecione a data', 'error');
        return;
      }

      if (!contaId) {
        Utils.showToast('Selecione uma conta', 'error');
        return;
      }

      if (!categoria) {
        Utils.showToast('Selecione uma categoria', 'error');
        return;
      }

      // Define tipo
      let tipo = currentType;
      if (editingId && fieldType.style.display !== 'none') {
        const selected = Array.from(txForm.elements['type']).find(r => r.checked);
        tipo = selected && selected.value === 'income' ? 'receita' : 'despesa';
      }

      const dados = {
        contaId,
        tipo,
        categoria,
        descricao,
        valor,
        data
      };

      let result;
      if (editingId) {
        result = Transactions.atualizar(editingId, dados);
      } else {
        result = Transactions.criar(dados);
      }

      if (result.success) {
        Utils.showToast(result.message, 'success');
        closeModal();
        renderLists();
      } else {
        Utils.showToast(result.message, 'error');
      }
    });

    // === DELEGA√á√ÉO DE EVENTOS ===
    function handleAction(e) {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;

      const card = btn.closest('.card');
      const id = card.dataset.id;

      if (btn.dataset.action === 'edit') {
        openEditModal(id);
      } else if (btn.dataset.action === 'delete') {
        Utils.showConfirm(
          'Tem certeza que deseja excluir esta transa√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.',
          'Excluir',
          'Cancelar'
        ).then((confirmed) => {
          if (!confirmed) return;
          
          const result = Transactions.excluir(id);
          if (result.success) {
            Utils.showToast(result.message, 'success');
            renderLists();
          } else {
            Utils.showToast(result.message, 'error');
          }
        });
      }
    }

    pendentesList.addEventListener('click', handleAction);
    historicoList.addEventListener('click', handleAction);

    // === PERFIL ===
    document.getElementById('profile-top').addEventListener('click', () => {
      const user = Auth.getCurrentUser();
      if (user) {
        Utils.showToast(`Ol√°, ${user.nome}!`, 'info');
      }
    });

    // === M√ÅSCARA VALOR ===
    const valueInput = document.getElementById('t-value');
    valueInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^\d,]/g, '');
    });

    // === MODAL DE CATEGORIAS ===
    btnManageCategories.addEventListener('click', () => {
      categoryTabType = currentType;
      modalCategories.style.display = 'flex';
      modalCategories.classList.add('open');
      modalCategories.setAttribute('aria-hidden', 'false');
      updateCategoryTab();
      renderCategoriesList();
    });

    closeCategoriesBtn.addEventListener('click', () => {
      modalCategories.style.display = 'none';
      modalCategories.classList.remove('open');
      modalCategories.setAttribute('aria-hidden', 'true');
    });

    tabReceitas.addEventListener('click', () => {
      categoryTabType = 'receita';
      updateCategoryTab();
      renderCategoriesList();
    });

    tabDespesas.addEventListener('click', () => {
      categoryTabType = 'despesa';
      updateCategoryTab();
      renderCategoriesList();
    });

    function updateCategoryTab() {
      if (categoryTabType === 'receita') {
        tabReceitas.classList.remove('outline');
        tabDespesas.classList.add('outline');
      } else {
        tabDespesas.classList.remove('outline');
        tabReceitas.classList.add('outline');
      }
    }

    function renderCategoriesList() {
      const categories = Categories.getByType(categoryTabType);
      categoriesList.innerHTML = '';

      if (categories.length === 0) {
        categoriesList.innerHTML = `
          <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5); font-size: 14px;">
            Nenhuma categoria encontrada
          </div>
        `;
        return;
      }

      categories.forEach(cat => {
        const item = document.createElement('div');
        item.style.cssText = `
          display: flex;
          align-items: center;
          gap: 14px;
          padding: 14px;
          background: rgba(255,255,255,0.08);
          border: 1px solid rgba(255,255,255,0.1);
          border-radius: 10px;
          margin-bottom: 10px;
          transition: all 0.2s ease;
        `;
        
        // Efeito hover
        item.addEventListener('mouseenter', () => {
          item.style.background = 'rgba(255,255,255,0.12)';
          item.style.borderColor = cat.cor;
        });
        item.addEventListener('mouseleave', () => {
          item.style.background = 'rgba(255,255,255,0.08)';
          item.style.borderColor = 'rgba(255,255,255,0.1)';
        });

        const colorDot = document.createElement('div');
        colorDot.style.cssText = `
          width: 40px;
          height: 40px;
          background: ${cat.cor};
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
          flex-shrink: 0;
        `;
        colorDot.textContent = cat.icone;

        const info = document.createElement('div');
        info.style.flex = '1';
        info.innerHTML = `
          <div style="font-weight: 600; color: #fff; font-size: 15px; margin-bottom: 3px;">${cat.nome}</div>
          <div style="font-size: 12px; color: rgba(255,255,255,0.65);">
            ${cat.custom ? '‚úèÔ∏è Personalizada' : 'üîí Padr√£o do sistema'}
          </div>
        `;

        item.appendChild(colorDot);
        item.appendChild(info);

        if (cat.custom) {
          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'btn small outline';
          deleteBtn.textContent = 'Excluir';
          deleteBtn.style.cssText = 'padding: 8px 14px; font-size: 13px; border-color: #ff9e9e; color: #ff9e9e; flex-shrink: 0;';
          deleteBtn.addEventListener('mouseenter', () => {
            deleteBtn.style.background = 'rgba(255,158,158,0.15)';
          });
          deleteBtn.addEventListener('mouseleave', () => {
            deleteBtn.style.background = 'transparent';
          });
          deleteBtn.addEventListener('click', () => {
            Utils.showConfirm(
              `Deseja excluir a categoria "${cat.nome}"?`,
              'Excluir',
              'Cancelar'
            ).then((confirmed) => {
              if (!confirmed) return;

              const result = Categories.excluir(cat.id, categoryTabType);
              if (result.success) {
                Utils.showToast(result.message, 'success');
                renderCategoriesList();
                loadCategoriesSelect(categoryTabType);
              } else {
                Utils.showToast(result.message, 'error');
              }
            });
          });
          item.appendChild(deleteBtn);
        }

        categoriesList.appendChild(item);
      });
    }

    formNewCategory.addEventListener('submit', (e) => {
      e.preventDefault();

      const nome = document.getElementById('new-cat-name').value.trim();
      const icone = document.getElementById('new-cat-icon').value.trim() || 'üìå';
      const cor = document.getElementById('new-cat-color').value;

      if (!nome) {
        Utils.showToast('Digite o nome da categoria', 'error');
        return;
      }

      const result = Categories.criar(categoryTabType, { nome, icone, cor });

      if (result.success) {
        Utils.showToast(result.message, 'success');
        formNewCategory.reset();
        document.getElementById('new-cat-color').value = '#58a6ff';
        renderCategoriesList();
        loadCategoriesSelect(categoryTabType);
      } else {
        Utils.showToast(result.message, 'error');
      }
    });

    // === INIT ===
    function init() {
      Accounts.init();
      loadAccountsSelect();
      loadCategoriesSelect(currentType);
      loadFilterSelects();
      renderLists();
    }

    init();
  </script>
</body>
</html>
