<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Histórico</title>
  <link rel="stylesheet" href="css/historico.css" />
</head>
<body>
  <main class="app" role="main" aria-labelledby="main-title">
    <header class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true">
         <img src="logo.png" alt="">
        </div>
        <div>
          <h1 id="main-title">GoalWallet</h1>
          <div class="subtitle">Histórico de Transações</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <button id="toggle-edit" class="pill" aria-pressed="false" type="button" title="Editar transações">Editar</button>
        <button id="profile-top" class="icon-btn" aria-label="Acesso ao perfil" title="Perfil">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6" aria-hidden="true">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"></path>
            <path d="M4 20c0-3.31 2.69-6 6-6h4c3.31 0 6 2.69 6 6"></path>
          </svg>
        </button>
      </div>
    </header>

    <div class="grid-2" role="group" aria-label="Listas de transações">
      <section aria-labelledby="pendentes">
        <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h2 id="pendentes" class="section-title">Pendentes</h2>
          <div class="actions-inline muted" aria-hidden="true"></div>
        </div>

        <div class="list-wrapper">
          <div id="pendentes-list" class="scheduled" role="list" aria-label="Lista de pendentes"></div>
        </div>
      </section>

      <section aria-labelledby="historico">
        <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h2 id="historico" class="section-title">Histórico</h2>
          <div></div>
        </div>

        <div class="list-wrapper">
          <div id="historico-list" class="scheduled" role="list" aria-label="Histórico de transações"></div>
        </div>
      </section>
    </div>

    <section style="margin-top:18px;" aria-labelledby="quick-actions">
      <h2 id="quick-actions" class="section-title">Ações rápidas</h2>
      <div class="actions">
        <button class="btn green" id="add-income" aria-haspopup="dialog" type="button">Adicionar Receita</button>
        <button class="btn red" id="add-expense" aria-haspopup="dialog" type="button">Adicionar Despesa</button>
      </div>
      <div class="total" id="total" aria-live="polite" style="margin-top:12px;color:var(--muted)">Total a vencer: R$ 0,00</div>
    </section>

    <div class="modal" id="modal" aria-hidden="true">
      <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1">
        <h3 id="modal-title">Nova transação</h3>
        <form id="tx-form">
          <div class="field">
            <label for="t-title">Título</label>
            <input id="t-title" name="title" type="text" autocomplete="off" />
          </div>

          <div class="field">
            <label for="t-value">Valor</label>
            <input id="t-value" name="value" type="text" inputmode="decimal" placeholder="0,00" aria-describedby="val-help" autocomplete="off" />
            <div id="val-help" class="muted" style="font-size:12px;margin-top:6px">Digite números; separador decimal: vírgula ou ponto.</div>
          </div>

          <div class="field">
            <label for="t-date">Data</label>
            <input id="t-date" name="date" type="date" />
          </div>

          <div class="field">
            <label for="t-account">Conta</label>
            <select id="t-account" name="account">
              <option value="nubank">Nubank - Conta</option>
              <option value="inter">Inter - Conta</option>
              <option value="caixa">Caixa - Conta</option>
            </select>
          </div>

          <div class="field" aria-label="Tipo">
            <label>Tipo</label>
            <div style="display:flex;gap:8px">
              <label><input type="radio" name="type" value="expense" checked /> Despesa</label>
              <label><input type="radio" name="type" value="income" /> Receita</label>
            </div>
          </div>

          <div class="field">
            <label for="t-status">Status</label>
            <select id="t-status" name="status">
              <option value="pending">Pendente</option>
              <option value="paid">Quitada</option>
            </select>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="btn" id="cancel" type="button">Cancelar</button>
            <button class="btn green" id="save" type="submit">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <div id="toast" role="status" aria-live="polite"></div>

  <template id="tx-card-tpl">
    <div class="card" role="listitem" data-id="">
      <div class="tx-left">
        <div class="small tx-title"></div>
        <div class="subtle tx-sub"></div>
      </div>
      <div class="tx-right">
        <div class="amount tx-amt"></div>
        <div class="status-pill tx-status"></div>
        <div class="tx-actions"></div>
      </div>
    </div>
  </template>

  <script>

    const STORAGE_KEY = 'goalwallet_transactions_v1';
    let transactions = [
      { id: '1', title: 'Assinatura Netflix', cents: 2990, date: '2025-10-10', recurring:true, type:'expense', status:'paid', account:'nubank' },
      { id: '2', title: 'Aluguel', cents: 120000, date: '2025-11-05', recurring:true, type:'expense', status:'pending', account:'caixa' },
      { id: '3', title: 'Plano Saúde', cents: 25000, date: '2025-10-20', recurring:true, type:'expense', status:'pending', account:'inter' },
      { id: '4', title: 'Conta de luz', cents: 32000, date: '2025-10-08', recurring:true, type:'expense', status:'pending', account:'nubank' },
    ];

    function loadFromStorage(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed)) transactions = parsed;
        }
      }catch(e){
        console.warn('Falha ao ler localStorage', e);
      }
    }

    let saveTimer = null;
    function saveToStorage(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
        }catch(e){
          console.warn('Falha ao salvar localStorage', e);
        }
      }, 260);
    }

    const formatBRL = (cents) => new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' }).format((Number(cents)||0)/100);

    function parseLocaleMoney(str){
      if(str === null || str === undefined) return NaN;
      if(typeof str === 'number') return Math.round(str*100);
      let cleaned = String(str).replace(/\s/g,'').replace(/[^\d\.,-]/g,'').trim();
      if(cleaned === '') return NaN;
      const negative = cleaned.includes('-');
      cleaned = cleaned.replace(/-/g,'');
      const hasDot = cleaned.indexOf('.') !== -1;
      const hasComma = cleaned.indexOf(',') !== -1;
      if(hasDot && hasComma){
        const tmp = cleaned.replace(/\./g,'').replace(/,/g,'.');
        const f = parseFloat(tmp);
        return isNaN(f) ? NaN : Math.round((negative?-1:1)*f*100);
      }
      if(hasComma){
        const tmp = cleaned.replace(/\./g,'').replace(/,/g,'.');
        const f = parseFloat(tmp);
        return isNaN(f) ? NaN : Math.round((negative?-1:1)*f*100);
      }
      const f = parseFloat(cleaned);
      return isNaN(f) ? NaN : Math.round((negative?-1:1)*f*100);
    }

    function getTotalPendingCents(){
      return transactions.filter(t => t.status === 'pending' && t.type === 'expense').reduce((s,t) => s + (Number(t.cents)||0), 0);
    }

    function showToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      t.style.opacity = '1';
      clearTimeout(window._toastTimeout);
      window._toastTimeout = setTimeout(()=>{ t.style.opacity = '0'; setTimeout(()=> t.style.display = 'none', 250); }, 2200);
    }

    const pendentesList = document.getElementById('pendentes-list');
    const historicoList = document.getElementById('historico-list');
    const tpl = document.getElementById('tx-card-tpl');

    function createCard(tx){
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.dataset.id = tx.id;
      node.querySelector('.tx-title').textContent = tx.title;
      const d = tx.date ? new Date(tx.date) : null;
      node.querySelector('.tx-sub').textContent = 'Venc. ' + (d ? d.toLocaleDateString('pt-BR',{day:'2-digit', month:'short'}) : '—') + (tx.recurring? ' • Mensal':'');
      const amt = node.querySelector('.tx-amt');
      amt.className = 'amount tx-amt ' + (tx.type === 'expense' ? 'expense' : 'income');
      amt.textContent = formatBRL(tx.cents);
      const pill = node.querySelector('.tx-status');
      pill.className = 'status-pill ' + (tx.status === 'paid' ? 'status-paid' : 'status-pending');
      pill.textContent = tx.status === 'paid' ? 'Pago' : 'Pendente';

      const actions = node.querySelector('.tx-actions');
      actions.innerHTML = '';

      
      if(tx.status === 'pending'){
        const confirmBtn = document.createElement('button');
        confirmBtn.type = 'button';
        confirmBtn.className = 'confirm-btn';
        confirmBtn.textContent = 'Confirmar pagamento';
        confirmBtn.dataset.action = 'confirm';
        actions.appendChild(confirmBtn);
      }

      const editBtn = document.createElement('button');
      editBtn.className = 'icon-btn';
      editBtn.type = 'button';
      editBtn.innerHTML = '✎';
      editBtn.title = 'Editar';
      editBtn.dataset.action = 'edit';
      actions.appendChild(editBtn);

      const delBtn = document.createElement('button');
      delBtn.className = 'icon-btn';
      delBtn.type = 'button';
      delBtn.innerHTML = '🗑';
      delBtn.title = 'Excluir';
      delBtn.dataset.action = 'delete';
      actions.appendChild(delBtn);

      return node;
    }

    function renderList({container, filterFn}){
      container.innerHTML = '';
      const frag = document.createDocumentFragment();
      const filtered = transactions.filter(filterFn);
      if(filtered.length === 0){
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = container.id === 'pendentes-list' ? 'Nenhuma transação pendente.' : 'Nenhuma transação no histórico.';
        frag.appendChild(empty);
      } else {
        filtered.forEach(tx => {
          const card = createCard(tx);
          if(!isEditMode){
            const actions = card.querySelector('.tx-actions');
            Array.from(actions.children).forEach(btn => {
              if(btn.dataset.action === 'edit' || btn.dataset.action === 'delete'){
                btn.style.display = 'none';
              }
            });
          }
          frag.appendChild(card);
        });
      }
      container.appendChild(frag);
    }

    function reRenderAll(){
      renderList({container: pendentesList, filterFn: t => t.status === 'pending'});
      renderList({container: historicoList, filterFn: t => t.status === 'paid'});
      document.getElementById('total').textContent = 'Total a vencer: ' + formatBRL(getTotalPendingCents());
      saveToStorage();
    }
   
    function confirmPayment(id){
      const tx = transactions.find(t => t.id === id);
      if(!tx) return;
      tx.status = 'paid';
      showToast('Pagamento confirmado.');
      reRenderAll();
    }

    function deleteTx(id){
      const tx = transactions.find(t => t.id === id);
      if(!tx) return;
      if(!confirm('Deseja excluir esta transação? Esta ação não pode ser desfeita.')) return;
      transactions = transactions.filter(t => t.id !== id);
      showToast('Transação excluída.');
      reRenderAll();
    }

    const modal = document.getElementById('modal');
    const sheet = modal.querySelector('.sheet');
    const addIncome = document.getElementById('add-income');
    const addExpense = document.getElementById('add-expense');
    const cancel = document.getElementById('cancel');
    const form = document.getElementById('tx-form');
    let lastFocused = null;
    let editingId = null;

    function openModal(type){
      lastFocused = document.activeElement;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      document.querySelector('main').setAttribute('aria-hidden','true');
      document.body.style.overflow = 'hidden';
      document.getElementById('modal-title').textContent = type === 'income' ? 'Nova receita' : 'Nova despesa';
      Array.from(form.elements['type']).forEach(r=> r.checked = (r.value === type));
      form.elements['title'].value = '';
      form.elements['value'].value = '';
      form.elements['date'].value = '';
      form.elements['account'].value = 'nubank';
      form.elements['status'].value = (type === 'expense') ? 'pending' : 'paid';
      editingId = null;
      setTimeout(()=> document.getElementById('t-title').focus(), 60);
    }

    function openEditModal(id){
      const tx = transactions.find(t => t.id === id);
      if(!tx) return;
      lastFocused = document.activeElement;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      document.querySelector('main').setAttribute('aria-hidden','true');
      document.body.style.overflow = 'hidden';
      document.getElementById('modal-title').textContent = tx.type === 'income' ? 'Editar receita' : 'Editar despesa';
      form.elements['title'].value = tx.title;
      form.elements['value'].value = formatBRL(tx.cents);
      form.elements['date'].value = tx.date || '';
      form.elements['account'].value = tx.account || 'nubank';
      Array.from(form.elements['type']).forEach(r=> r.checked = (r.value === tx.type));
      form.elements['status'].value = tx.status || 'pending';
      editingId = tx.id;
      setTimeout(()=> document.getElementById('t-title').focus(), 60);
    }

    function closeModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      document.querySelector('main').removeAttribute('aria-hidden');
      document.body.style.overflow = '';
      lastFocused?.focus();
    }

    addIncome.addEventListener('click', ()=> openModal('income'));
    addExpense.addEventListener('click', ()=> openModal('expense'));
    cancel.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.classList.contains('open')) closeModal(); });

    sheet.addEventListener('keydown', (e)=>{
      if(e.key !== 'Tab') return;
      const focusable = sheet.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
      const focusableArr = Array.prototype.slice.call(focusable).filter(el => el.offsetParent !== null);
      if(focusableArr.length === 0) return;
      const first = focusableArr[0];
      const last = focusableArr[focusableArr.length -1];
      if(e.shiftKey){
        if(document.activeElement === first){ e.preventDefault(); last.focus(); }
      } else {
        if(document.activeElement === last){ e.preventDefault(); first.focus(); }
      }
    });

    const tValue = document.getElementById('t-value');
    function unformatForEditing(formatted){
      const cents = parseLocaleMoney(formatted);
      if(isNaN(cents)) return '';
      return (cents/100).toFixed(2).replace('.', ',');
    }
    function maskMoneyInputSimple(el){
      el.addEventListener('input', ()=>{
        const raw = el.value;
        const cleaned = raw.replace(/[^\d\.,-]/g,'');
        const parts = cleaned.split(/[,\.]/);
        if(parts.length > 2){
          const decimals = parts.slice(-1);
          const ints = parts.slice(0, -1).join('');
          el.value = ints + ',' + decimals.join('');
        } else {
          el.value = cleaned;
        }
      });
      el.addEventListener('paste', (e)=>{
        const txt = (e.clipboardData || window.clipboardData).getData('text');
        if(!txt) return;
        const cleaned = txt.replace(/[^0-9\.,-]/g,'');
        if(cleaned === '') e.preventDefault();
        else {
          e.preventDefault();
          const start = el.selectionStart || 0;
          const end = el.selectionEnd || 0;
          const before = el.value.slice(0,start);
          const after = el.value.slice(end);
          el.value = (before + cleaned + after).replace(/[^\d\.,-]/g,'');
        }
      });
      el.addEventListener('focus', ()=>{ if(el.value.trim() === '') return; const editable = unformatForEditing(el.value); if(editable !== '') el.value = editable; });
      el.addEventListener('blur', ()=>{ const cents = parseLocaleMoney(el.value); if(!isNaN(cents)) el.value = formatBRL(cents); else el.value = ''; });
    }
    maskMoneyInputSimple(tValue);

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const title = form.elements['title'].value.trim();
      const valueStr = form.elements['value'].value;
      const dateVal = form.elements['date'].value;
      const account = form.elements['account'].value;
      const type = Array.from(form.elements['type']).find(r=>r.checked).value;
      const status = form.elements['status'].value;

      if(!title){ showToast('Preencha um título válido.'); return; }
      const cents = parseLocaleMoney(valueStr);
      if(isNaN(cents) || cents <= 0){ showToast('Informe um valor válido maior que 0.'); return; }

      if(editingId){
        const tx = transactions.find(t => t.id === editingId);
        if(!tx){ showToast('Transação não encontrada.'); closeModal(); return; }
        tx.title = title;
        tx.cents = cents;
        tx.date = dateVal || null;
        tx.account = account;
        tx.type = type;
        tx.status = status || (type === 'expense' ? 'pending' : 'paid');
        showToast('Transação atualizada.');
      } else {
        const tx = { id: String(Date.now()), title, cents, date: dateVal || null, recurring:true, type, status: status || (type === 'expense' ? 'pending' : 'paid'), account };
        transactions.unshift(tx);
        showToast('Transação salva.');
      }

      reRenderAll();
      closeModal();
    });

    const toggleEdit = document.getElementById('toggle-edit');
    let isEditMode = false;
    function setEditMode(on){
      isEditMode = !!on;
      toggleEdit.setAttribute('aria-pressed', String(isEditMode));
      toggleEdit.textContent = isEditMode ? 'Concluir edição' : 'Editar';
      reRenderAll();
    }
    toggleEdit.addEventListener('click', ()=> setEditMode(!isEditMode));

    function handleListClick(e){
      const btn = e.target.closest('[data-action]');
      if(!btn) return;
      const card = btn.closest('.card');
      if(!card) return;
      const id = card.dataset.id;
      const action = btn.dataset.action;
      if(action === 'confirm') confirmPayment(id);
      else if(action === 'edit') openEditModal(id);
      else if(action === 'delete') deleteTx(id);
    }
    pendentesList.addEventListener('click', handleListClick);
    historicoList.addEventListener('click', handleListClick);

    function init(){
      loadFromStorage();
      reRenderAll();
    }
    init();
  </script>
</body>
</html>
